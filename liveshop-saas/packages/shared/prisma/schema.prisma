generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT & USER MANAGEMENT
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  plan      String   @default("free") // free, starter, pro, enterprise
  status    String   @default("active") // active, suspended, cancelled
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users  User[]
  stores Store[]
  orders Order[]

  @@map("tenants")
}

model User {
  id       String @id @default(uuid())
  tenantId String @map("tenant_id")
  email    String @unique
  phone    String?
  password String // hashed

  role   String @default("customer") // customer, store_owner, store_staff, driver, admin, super_admin
  status String @default("active") // active, suspended, pending_verification, deleted

  profile Json @default("{}") // { firstName, lastName, avatar, dateOfBirth }
  kycStatus String @default("pending") @map("kyc_status") // pending, verified, rejected
  kycData   Json   @default("{}") @map("kyc_data") // documents, verification details

  walletBalance Decimal @default(0) @map("wallet_balance") @db.Decimal(12, 2)
  currency      String  @default("SAR")

  stripeCustomerId String? @map("stripe_customer_id") // kept for backward compat
  moyasarCustomerId String? @map("moyasar_customer_id")

  emailVerified DateTime? @map("email_verified")
  phoneVerified DateTime? @map("phone_verified")
  lastLoginAt   DateTime? @map("last_login_at")

  passwordResetToken     String?   @map("password_reset_token")
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  ownedStores     Store[]          @relation("StoreOwner")
  storeMemberships StoreMember[]
  streams         LiveStream[]     @relation("StreamHost")
  streamMessages  StreamMessage[]
  streamViews     StreamView[]
  orders          Order[]          @relation("OrderCustomer")
  driverProfile   DriverProfile?
  deliveries      Delivery[]       @relation("DeliveryDriver")
  notifications   Notification[]
  addresses       Address[]
  paymentMethods  PaymentMethod[]
  payouts         Payout[]         @relation("PayoutRecipient")
  refreshTokens   RefreshToken[]

  @@index([tenantId])
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Address {
  id     String @id @default(uuid())
  userId String @map("user_id")
  type   String @default("shipping") // shipping, billing, both

  label       String? // Home, Work, etc.
  recipient   String?
  phone       String?
  street1     String
  street2     String?
  city        String
  state       String
  postalCode  String  @map("postal_code")
  country     String  @default("US")
  coordinates Json? // { lat, lng }

  isDefault Boolean @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model PaymentMethod {
  id     String @id @default(uuid())
  userId String @map("user_id")

  type        String // card, bank_account
  stripeId    String @map("stripe_id")
  last4       String
  brand       String? // visa, mastercard, etc.
  expMonth    Int?    @map("exp_month")
  expYear     Int?    @map("exp_year")
  isDefault   Boolean @default(false) @map("is_default")
  billingDetails Json? @map("billing_details")

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payment_methods")
}

// ============================================
// STORE & PRODUCT MANAGEMENT
// ============================================

model Store {
  id       String @id @default(uuid())
  tenantId String @map("tenant_id")
  ownerId  String @map("owner_id")

  name        String
  slug        String  @unique
  description String?
  logoUrl     String? @map("logo_url")
  coverUrl    String? @map("cover_url")
  website     String?

  category    String?
  subcategory String?

  address Json // { street, city, state, postalCode, country, coordinates }

  settings Json @default("{}") // { 
  //   workingHours: {},
  //   deliveryRadius: 10,
  //   minimumOrder: 0,
  //   preparationTime: 30,
  //   autoAcceptOrders: false,
  //   allowScheduledDelivery: true
  // }

  verificationStatus String   @default("pending") @map("verification_status")
  verifiedAt         DateTime? @map("verified_at")

  rating       Decimal @default(5.0) @db.Decimal(2, 1)
  reviewCount  Int     @default(0) @map("review_count")
  orderCount   Int     @default(0) @map("order_count")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant        @relation(fields: [tenantId], references: [id])
  owner    User          @relation("StoreOwner", fields: [ownerId], references: [id])
  members  StoreMember[]
  products Product[]
  streams  LiveStream[]
  orders   Order[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([category])
  @@index([verificationStatus])
  @@index([isActive])
  @@map("stores")
}

model StoreMember {
  id      String @id @default(uuid())
  storeId String @map("store_id")
  userId  String @map("user_id")

  role     String   @default("staff") // owner, manager, staff
  permissions Json  @default("[]") // ["products", "orders", "streams", "analytics"]
  joinedAt DateTime @default(now()) @map("joined_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storeId, userId])
  @@index([storeId])
  @@index([userId])
  @@map("store_members")
}

model Product {
  id      String @id @default(uuid())
  storeId String @map("store_id")

  name        String
  description String?
  sku         String?
  barcode     String?

  price           Decimal @db.Decimal(10, 2)
  compareAtPrice  Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  costPrice       Decimal? @map("cost_price") @db.Decimal(10, 2)

  inventoryQuantity Int    @default(0) @map("inventory_quantity")
  inventoryPolicy   String @default("deny") @map("inventory_policy") // deny, continue
  inventoryTracking Boolean @default(true) @map("inventory_tracking")

  weight      Decimal? @db.Decimal(8, 2)
  weightUnit  String   @default("kg") @map("weight_unit")

  images      String[]
  videos      String[]

  variants    Json     @default("[]") // [{ id, name, options, price, sku, quantity, image }]
  attributes  Json     @default("{}") // { color, size, material, etc. }
  tags        String[]

  seoTitle       String? @map("seo_title")
  seoDescription String? @map("seo_description")

  isActive    Boolean  @default(true) @map("is_active")
  isFeatured  Boolean  @default(false) @map("is_featured")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  pinnedInStreams StreamPinnedProduct[]
  orderItems      OrderItem[]

  @@index([storeId])
  @@index([isActive])
  @@index([isFeatured])
  @@map("products")
}

// ============================================
// LIVE STREAMING
// ============================================

model LiveStream {
  id      String @id @default(uuid())
  storeId String @map("store_id")
  hostId  String @map("host_id")

  title       String
  description String?
  thumbnailUrl String? @map("thumbnail_url")

  type String @default("public") // public, private, scheduled
  status String @default("scheduled") // scheduled, live, ended, cancelled

  scheduledAt DateTime? @map("scheduled_at")
  startedAt   DateTime? @map("started_at")
  endedAt     DateTime? @map("ended_at")
  duration    Int? // seconds

  // WebRTC/MediaSoup
  roomId     String? @unique @map("room_id")
  streamKey  String? @map("stream_key")
  playbackUrl String? @map("playback_url")
  rtmpUrl    String? @map("rtmp_url")

  // Chat settings
  chatEnabled     Boolean @default(true) @map("chat_enabled")
  reactionsEnabled Boolean @default(true) @map("reactions_enabled")
  moderationEnabled Boolean @default(false) @map("moderation_enabled")

  // Analytics
  viewerCount    Int     @default(0) @map("viewer_count")
  peakViewers    Int     @default(0) @map("peak_viewers")
  totalViews     Int     @default(0) @map("total_views")
  totalWatchTime Int     @default(0) @map("total_watch_time") // seconds
  uniqueViewers  Int     @default(0) @map("unique_viewers")

  likes    Int @default(0)
  shares   Int @default(0)
  comments Int @default(0)

  // Revenue
  ordersDuringStream Int     @default(0) @map("orders_during_stream")
  revenueDuringStream Decimal @default(0) @map("revenue_during_stream") @db.Decimal(12, 2)

  settings  Json @default("{}")
  analytics Json @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  store    Store           @relation(fields: [storeId], references: [id])
  host     User            @relation("StreamHost", fields: [hostId], references: [id])
  messages StreamMessage[]
  views    StreamView[]
  pinnedProducts StreamPinnedProduct[]
  orders   Order[]

  @@index([storeId])
  @@index([hostId])
  @@index([status])
  @@index([type])
  @@index([scheduledAt])
  @@map("live_streams")
}

model StreamPinnedProduct {
  id        String @id @default(uuid())
  streamId  String @map("stream_id")
  productId String @map("product_id")

  pinnedAt   DateTime @default(now()) @map("pinned_at")
  unpinnedAt DateTime? @map("unpinned_at")
  pinnedBy   String   @map("pinned_by")

  discountPercent Int? @map("discount_percent")
  flashSale       Boolean @default(false) @map("flash_sale")
  flashSaleEndsAt DateTime? @map("flash_sale_ends_at")

  clicks    Int @default(0)
  purchases Int @default(0)

  stream  LiveStream @relation(fields: [streamId], references: [id], onDelete: Cascade)
  product Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([streamId, productId, pinnedAt])
  @@index([streamId])
  @@index([productId])
  @@map("stream_pinned_products")
}

model StreamMessage {
  id       String @id @default(uuid())
  streamId String @map("stream_id")
  userId   String @map("user_id")

  type    String @default("text") // text, reaction, product_request, order_notification, system
  content String

  metadata Json? // { productId, orderId, reaction, etc. }

  isPinned  Boolean @default(false) @map("is_pinned")
  isDeleted Boolean @default(false) @map("is_deleted")

  createdAt DateTime @default(now()) @map("created_at")

  stream LiveStream @relation(fields: [streamId], references: [id], onDelete: Cascade)
  user   User       @relation(fields: [userId], references: [id])

  @@index([streamId])
  @@index([userId])
  @@index([createdAt])
  @@map("stream_messages")
}

model StreamView {
  id       String @id @default(uuid())
  streamId String @map("stream_id")
  userId   String @map("user_id")

  joinedAt   DateTime  @default(now()) @map("joined_at")
  leftAt     DateTime? @map("left_at")
  watchTime  Int       @default(0) @map("watch_time") // seconds

  deviceType String? @map("device_type")
  ipAddress  String? @map("ip_address")
  country    String?

  messagesCount  Int @default(0) @map("messages_count")
  reactionsCount Int @default(0) @map("reactions_count")
  productsClicked Int @default(0) @map("products_clicked")
  orderPlaced    Boolean @default(false) @map("order_placed")
  orderValue     Decimal? @map("order_value") @db.Decimal(12, 2)

  stream LiveStream @relation(fields: [streamId], references: [id], onDelete: Cascade)
  user   User       @relation(fields: [userId], references: [id])

  @@unique([streamId, userId, joinedAt])
  @@index([streamId])
  @@index([userId])
  @@map("stream_views")
}

// ============================================
// ORDERS & COMMERCE
// ============================================

model Order {
  id          String @id @default(uuid())
  orderNumber String @unique @map("order_number")

  tenantId   String  @map("tenant_id")
  customerId String  @map("customer_id")
  storeId    String  @map("store_id")
  streamId   String? @map("stream_id")

  status String @default("pending")
  // pending, confirmed, preparing, ready_for_pickup, 
  // picked_up, in_transit, delivered, cancelled, refunded, disputed

  paymentStatus String @default("pending") @map("payment_status")
  // pending, authorized, captured, failed, refunded, partially_refunded

  fulfillmentStatus String @default("unfulfilled") @map("fulfillment_status")
  // unfulfilled, fulfilled, partial, returned

  // Financials
  subtotal       Decimal @db.Decimal(12, 2)
  taxAmount      Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  taxRate        Decimal @default(0) @map("tax_rate") @db.Decimal(5, 4)
  shippingAmount Decimal @default(0) @map("shipping_amount") @db.Decimal(12, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(12, 2)
  tipAmount      Decimal @default(0) @map("tip_amount") @db.Decimal(12, 2)
  totalAmount    Decimal @map("total_amount") @db.Decimal(12, 2)

  currency String @default("SAR")

  // Applied discounts
  couponCode   String? @map("coupon_code")
  couponDiscount Decimal? @map("coupon_discount") @db.Decimal(12, 2)

  // Addresses
  shippingAddress Json @map("shipping_address")
  billingAddress  Json? @map("billing_address")

  // Timestamps
  confirmedAt        DateTime? @map("confirmed_at")
  preparingAt        DateTime? @map("preparing_at")
  readyForPickupAt   DateTime? @map("ready_for_pickup_at")
  pickedUpAt         DateTime? @map("picked_up_at")
  deliveredAt        DateTime? @map("delivered_at")
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason")

  // Relations
  customerNote String? @map("customer_note")
  internalNote String? @map("internal_note")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  customer User      @relation("OrderCustomer", fields: [customerId], references: [id])
  store    Store     @relation(fields: [storeId], references: [id])
  stream   LiveStream? @relation(fields: [streamId], references: [id])

  items     OrderItem[]
  payments  Payment[]
  refunds   Refund[]
  delivery  Delivery?
  timeline  OrderTimeline[]

  @@index([tenantId])
  @@index([customerId])
  @@index([storeId])
  @@index([streamId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String @map("order_id")

  productId String  @map("product_id")
  variantId String? @map("variant_id")

  name     String
  sku      String?
  image    String?

  quantity  Int
  unitPrice Decimal @map("unit_price") @db.Decimal(10, 2)
  total     Decimal @db.Decimal(12, 2)

  // At time of purchase
  productData Json? @map("product_data") // snapshot of product

  // Fulfillment
  fulfilledQuantity Int @default(0) @map("fulfilled_quantity")
  returnedQuantity  Int @default(0) @map("returned_quantity")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderTimeline {
  id      String @id @default(uuid())
  orderId String @map("order_id")

  status String
  note   String?

  actorId   String? @map("actor_id")
  actorType String? @map("actor_type") // customer, store_staff, driver, system, admin

  metadata Json? // additional context

  createdAt DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_timeline")
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id      String @id @default(uuid())
  orderId String @map("order_id")

  // Moyasar payment fields
  moyasarPaymentId  String? @unique @map("moyasar_payment_id")
  moyasarInvoiceKey String? @map("moyasar_invoice_key")

  // Legacy Stripe fields (kept for data migration)
  stripePaymentIntentId String? @map("stripe_payment_intent_id")
  stripeChargeId        String? @map("stripe_charge_id")

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("SAR")

  status String // requires_confirmation, processing, succeeded, failed, cancelled

  paymentMethodType   String? @map("payment_method_type") // card, bank_transfer, etc.
  paymentMethodDetails Json?  @map("payment_method_details")

  receiptUrl     String? @map("receipt_url")
  failureMessage String? @map("failure_message")
  failureCode    String? @map("failure_code")

  capturedAt DateTime? @map("captured_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  refunds Refund[]

  @@index([orderId])
  @@index([moyasarPaymentId])
  @@index([stripePaymentIntentId])
  @@map("payments")
}

model Refund {
  id        String @id @default(uuid())
  paymentId String @map("payment_id")
  orderId   String @map("order_id")

  moyasarRefundId String? @map("moyasar_refund_id")
  stripeRefundId String? @map("stripe_refund_id") // legacy

  amount  Decimal @db.Decimal(12, 2)
  reason  String?
  status  String // pending, succeeded, failed

  processedBy String? @map("processed_by")
  processedAt DateTime? @map("processed_at")

  createdAt DateTime @default(now()) @map("created_at")

  payment Payment @relation(fields: [paymentId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])

  @@index([paymentId])
  @@index([orderId])
  @@map("refunds")
}

// ============================================
// DELIVERY & DRIVER MANAGEMENT
// ============================================

model DriverProfile {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  vehicleType        String @map("vehicle_type") // bicycle, motorcycle, car, van
  vehicleMake        String? @map("vehicle_make")
  vehicleModel       String? @map("vehicle_model")
  vehicleYear        Int?    @map("vehicle_year")
  vehicleColor       String? @map("vehicle_color")
  vehiclePlateNumber String? @map("vehicle_plate_number")

  licenseNumber    String? @map("license_number")
  licenseExpiry    DateTime? @map("license_expiry")
  insuranceNumber  String? @map("insurance_number")
  insuranceExpiry  DateTime? @map("insurance_expiry")

  backgroundCheckStatus  String @default("pending") @map("background_check_status")
  backgroundCheckPassedAt DateTime? @map("background_check_passed_at")

  // Stats
  totalDeliveries   Int       @default(0) @map("total_deliveries")
  totalEarnings     Decimal   @default(0) @map("total_earnings") @db.Decimal(12, 2)
  rating            Decimal   @default(5.0) @db.Decimal(2, 1)
  reviewCount       Int       @default(0) @map("review_count")
  acceptanceRate    Decimal   @default(0) @map("acceptance_rate") @db.Decimal(5, 2)
  onTimeRate        Decimal   @default(0) @map("on_time_rate") @db.Decimal(5, 2)

  isOnline      Boolean   @default(false) @map("is_online")
  lastOnlineAt  DateTime? @map("last_online_at")
  currentLocation Json?   @map("current_location")

  preferredZones  String[] @map("preferred_zones")
  workingHours    Json?    @map("working_hours")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("driver_profiles")
}

model Delivery {
  id       String @id @default(uuid())
  orderId  String @unique @map("order_id")
  driverId String? @map("driver_id")

  status String @default("pending")
  // pending, searching_driver, driver_assigned, driver_accepted,
  // at_pickup, picked_up, in_transit, at_dropoff, delivered, failed, cancelled

  // Addresses
  pickupAddress  Json @map("pickup_address")
  dropoffAddress Json @map("dropoff_address")

  // Estimated times
  estimatedPickupAt   DateTime? @map("estimated_pickup_at")
  estimatedDeliveryAt DateTime? @map("estimated_delivery_at")

  // Actual times
  driverAssignedAt DateTime? @map("driver_assigned_at")
  acceptedAt       DateTime? @map("accepted_at")
  atPickupAt       DateTime? @map("at_pickup_at")
  pickedUpAt       DateTime? @map("picked_up_at")
  deliveredAt      DateTime? @map("delivered_at")

  // Distance & pricing
  estimatedDistance Decimal? @map("estimated_distance") @db.Decimal(8, 2) // km
  actualDistance    Decimal? @map("actual_distance") @db.Decimal(8, 2)
  deliveryFee       Decimal  @map("delivery_fee") @db.Decimal(10, 2)
  driverEarnings    Decimal  @map("driver_earnings") @db.Decimal(10, 2)
  tipAmount         Decimal  @default(0) @map("tip_amount") @db.Decimal(10, 2)

  // Tracking
  trackingData Json @default("[]") @map("tracking_data") // [{ lat, lng, timestamp, accuracy }]

  // Proof of delivery
  proofPhotoUrl   String? @map("proof_photo_url")
  signatureUrl    String? @map("signature_url")
  recipientName   String? @map("recipient_name")
  deliveryNotes   String? @map("delivery_notes")

  // Rating
  customerRating  Int?    @map("customer_rating")
  customerReview  String? @map("customer_review")
  driverRating    Int?    @map("driver_rating")
  driverReview    String? @map("driver_review")

  // Cancellation
  cancelledBy     String? @map("cancelled_by") // customer, driver, system, store
  cancellationReason String? @map("cancellation_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  order  Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  driver User? @relation("DeliveryDriver", fields: [driverId], references: [id])

  @@index([orderId])
  @@index([driverId])
  @@index([status])
  @@map("deliveries")
}

// ============================================
// PAYOUTS
// ============================================

model Payout {
  id            String @id @default(uuid())
  recipientId   String @map("recipient_id")
  recipientType String @map("recipient_type") // store, driver

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("SAR")

  status String @default("pending") // pending, processing, completed, failed

  moyasarTransferId String? @map("moyasar_transfer_id")
  stripeTransferId String? @map("stripe_transfer_id") // legacy
  stripePayoutId   String? @map("stripe_payout_id") // legacy

  periodStart DateTime? @map("period_start")
  periodEnd   DateTime? @map("period_end")

  ordersIncluded    Json @map("orders_included") // [orderId, orderId, ...]
  deliveriesIncluded Json? @map("deliveries_included")

  metadata Json?

  processedAt DateTime? @map("processed_at")
  failedAt    DateTime? @map("failed_at")
  failureReason String? @map("failure_reason")

  createdAt DateTime @default(now()) @map("created_at")

  recipient User @relation("PayoutRecipient", fields: [recipientId], references: [id])

  @@index([recipientId])
  @@index([status])
  @@map("payouts")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id     String @id @default(uuid())
  userId String @map("user_id")

  type    String // order_update, delivery_update, stream_start, promotion, system
  title   String
  body    String
  imageUrl String? @map("image_url")

  data Json? // payload for deep linking { orderId, streamId, etc. }

  channels String[] @default([]) // push, email, sms, in_app

  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")

  sentAt     DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  clickedAt  DateTime? @map("clicked_at")

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

model PushSubscription {
  id     String @id @default(uuid())
  userId String @map("user_id")

  endpoint String
  p256dh   String
  auth     String

  deviceType String? @map("device_type")
  deviceId   String? @map("device_id")

  isActive  Boolean  @default(true) @map("is_active")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([endpoint])
  @@map("push_subscriptions")
}

// ============================================
// AUDIT & ANALYTICS
// ============================================

model AuditLog {
  id String @id @default(uuid())

  userId    String? @map("user_id")
  tenantId  String? @map("tenant_id")
  entityType String @map("entity_type") // user, store, order, product, etc.
  entityId   String @map("entity_id")

  action    String // create, update, delete, login, logout, etc.
  oldValue  Json?  @map("old_value")
  newValue  Json?  @map("new_value")

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
