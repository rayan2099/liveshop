name: Deploy to Railway

on:
  workflow_run:
    workflows: ["Build and publish backend images"]
    types: [completed]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "Deploying Docker images to Railway..."
          
          COMMIT_SHA=${{ github.sha }}
          REGISTRY="ghcr.io/${{ github.repository_owner }}"
          API_IMAGE="${REGISTRY}/liveshop-api:${COMMIT_SHA}"
          STREAMING_IMAGE="${REGISTRY}/liveshop-streaming:${COMMIT_SHA}"
          
          # Deploy via Railway REST API
          API_URL="https://api.railway.app"
          
          # Query for project services
          SERVICES=$(curl -s -X POST "${API_URL}/graphql" \
            -H "Authorization: Bearer ${RAILWAY_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query GetServices { services(input: {projectId: \"'"${RAILWAY_PROJECT_ID}"'\"}) { edges { node { id name } } } }"
            }')
          
          echo "Services found: $SERVICES"
          
          # Extract service IDs - these would come from the response
          # For now, manually pass service IDs if they're known
          # Or user provides them via GitHub secrets
          
          if [ -n "${{ secrets.RAILWAY_API_SERVICE_ID }}" ]; then
            echo "Deploying API service..."
            curl -s -X POST "${API_URL}/graphql" \
              -H "Authorization: Bearer ${RAILWAY_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{
                "query": "mutation DeployImage($input: PluginDeployImageInput!) { pluginDeployImage(input: $input) { deployment { id } } }",
                "variables": {
                  "input": {
                    "serviceId": "'"${{ secrets.RAILWAY_API_SERVICE_ID }}"'",
                    "imageUri": "'"${API_IMAGE}"'"
                  }
                }
              }' | tee api-deploy.json
          fi
          
          if [ -n "${{ secrets.RAILWAY_STREAMING_SERVICE_ID }}" ]; then
            echo "Deploying Streaming service..."
            curl -s -X POST "${API_URL}/graphql" \
              -H "Authorization: Bearer ${RAILWAY_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{
                "query": "mutation DeployImage($input: PluginDeployImageInput!) { pluginDeployImage(input: $input) { deployment { id } } }",
                "variables": {
                  "input": {
                    "serviceId": "'"${{ secrets.RAILWAY_STREAMING_SERVICE_ID }}"'",
                    "imageUri": "'"${STREAMING_IMAGE}"'"
                  }
                }
              }' | tee streaming-deploy.json
          fi
          
          echo "âœ… Images built and ready:"
          echo "   API:       ${API_IMAGE}"
          echo "   Streaming: ${STREAMING_IMAGE}"
          echo ""
          echo "Next steps:"
          echo "1. Add these to GitHub Secrets (if doing automated deploy):"
          echo "   RAILWAY_API_SERVICE_ID: <your-api-service-id>"
          echo "   RAILWAY_STREAMING_SERVICE_ID: <your-streaming-service-id>"
          echo ""
          echo "2. OR manually deploy via Rail dashboard:"
          echo "   https://railway.app/project/${RAILWAY_PROJECT_ID}"
